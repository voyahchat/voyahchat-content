name: Update Daily Password

on:
  schedule:
    # 15:57 UTC = 18:57 Moscow = 23:57 Beijing (next day password)
    - cron: '57 15 * * *'
  workflow_dispatch: {}

jobs:
  update-password:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Calculate and update password
      run: |
        # Password is always for the CURRENT Beijing date
        # The cron runs at 15:57 UTC (23:57 Beijing), preparing for the next day
        # When run manually, it generates password for whatever day it is in Beijing now
        #
        # Examples:
        # - Manual run at 21:43 Moscow (18:43 UTC) = 02:43 Beijing Jan 7 -> password for Jan 7
        # - Manual run at 14:00 Moscow (11:00 UTC) = 19:00 Beijing Jan 6 -> password for Jan 6
        # - Cron at 18:57 Moscow (15:57 UTC) = 23:57 Beijing Jan 6 -> password for Jan 6
        #   (but by the time site deploys at 19:00 Moscow, Beijing is Jan 7)
        #
        # For scheduled runs, we need TOMORROW Beijing date (site deploys after midnight Beijing)
        # For manual runs, we need CURRENT Beijing date

        if [ "$GITHUB_EVENT_NAME" = "schedule" ]; then
          # Scheduled run at 15:57 UTC - need tomorrow Beijing date for when site deploys
          BEIJING_DATE=$(TZ=Asia/Shanghai date -d '+1 day' '+%Y %m %d')
        else
          # Manual run - use current Beijing date
          BEIJING_DATE=$(TZ=Asia/Shanghai date '+%Y %m %d')
        fi

        read YEAR MONTH DAY <<< "$BEIJING_DATE"

        # Format MMDD
        MMDD="${MONTH}${DAY}"

        # Calculate password: sum each column
        Y1=${YEAR:0:1}
        Y2=${YEAR:1:1}
        Y3=${YEAR:2:1}
        Y4=${YEAR:3:1}
        M1=${MMDD:0:1}
        M2=${MMDD:1:1}
        D1=${MMDD:2:1}
        D2=${MMDD:3:1}

        P1=$((Y1 + M1))
        P2=$((Y2 + M2))
        P3=$((Y3 + D1))
        P4=$((Y4 + D2))

        PASSWORD="${P1}${P2}${P3}${P4}"

        echo "Date: ${YEAR}-${MONTH}-${DAY}"
        echo "Password: ${PASSWORD}"

        # Update password.md - replace only the number at the start of matching lines
        FILE="common/password.md"

        # Replace only the digits before " — год"
        sed -i -E "s/^[0-9]+( +— год)/${YEAR}\1/" "$FILE"

        # Replace only the digits before " — месяц"
        sed -i -E "s/^[0-9]+( +— месяц)/${MMDD}\1/" "$FILE"

        # Replace only the digits before " — динамический"
        sed -i -E "s/^[0-9]+( +— динамический)/${PASSWORD}\1/" "$FILE"

    - name: Commit and push
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        if git diff --quiet common/password.md; then
          echo "No changes to commit"
          exit 0
        fi

        BEIJING_DATE=$(TZ=Asia/Shanghai date -d '+1 day' '+%Y-%m-%d')
        git add common/password.md
        git commit -m "Update password for ${BEIJING_DATE}"
        git push
